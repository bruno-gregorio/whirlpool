#!/bin/bash
# Setup dracut and generate UKIs during installation
# This script runs automatically during Debian installation via preseed

set -e

echo "=== Whirlpool: Configuring dracut and UKIs ==="

# Install refind if not present
if ! command -v refind-install >/dev/null 2>&1; then
    apt-get update
    apt-get install -y refind
fi

# Remove initramfs-tools (conflicts with dracut)
if dpkg -l | grep -q "^ii.*initramfs-tools"; then
    apt-get remove -y --purge initramfs-tools initramfs-tools-core
    apt-get autoremove -y
fi

# Enable dracut configuration
if [ -f /etc/dracut.conf.d/20-whirlpool-installed.conf.disabled ]; then
    mv /etc/dracut.conf.d/20-whirlpool-installed.conf.disabled \
       /etc/dracut.conf.d/20-whirlpool-installed.conf
fi

# Generate UKIs for all installed kernels
for KVER in /lib/modules/*; do
    KVER=$(basename "$KVER")
    
    # Skip if not a kernel directory
    [ -d "/lib/modules/$KVER" ] || continue
    
    echo "Generating UKI for kernel $KVER..."
    
    dracut --force \
        --uefi \
        --kver "$KVER" \
        "/boot/debian-${KVER}.efi"
    
    echo "âœ“ UKI generated: /boot/debian-${KVER}.efi"
done

# Update rEFInd to scan for new UKIs
if command -v refind-install >/dev/null 2>&1; then
    echo "Updating rEFInd configuration..."
    refind-install --yes
fi

echo "=== Dracut and UKI setup complete ==="
